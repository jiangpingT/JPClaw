# è®°å¿†è§„æ¨¡æ§åˆ¶ç­–ç•¥

## é—®é¢˜ï¼šå¦‚ä½•é¿å…è®°å¿†æ— é™å¢é•¿ï¼Ÿ

JPClawé€šè¿‡**ä¸‰çº§æ§åˆ¶æœºåˆ¶**ç¡®ä¿è®°å¿†åº“ä¸ä¼šæ— é™è†¨èƒ€ï¼š

## ğŸ”„ ä¸‰çº§æ§åˆ¶æµç¨‹

```
æ–°è®°å¿†åˆ›å»º
    â†“
[shortTerm] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                             â”‚
    â”‚ é«˜é¢‘è®¿é—®ï¼ˆ10æ¬¡+ï¼‰            â”‚ 30å¤©è¿‡æœŸ + ä½ä»·å€¼
    â”‚ è®¿é—®å¯†åº¦é«˜ï¼ˆ0.5/å¤©+ï¼‰        â”‚ â†’ è‡ªåŠ¨åˆ é™¤ ğŸ—‘ï¸
    â”‚ å­˜æ´»7å¤©+                     â”‚
    â†“                             â”‚
[midTerm] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”
    â”‚                             â”‚    â”‚
    â”‚ è¶…é«˜é¢‘è®¿é—®ï¼ˆ50æ¬¡+ï¼‰          â”‚    â”‚ 90å¤©è¿‡æœŸ + ä½ä»·å€¼
    â”‚ è®¿é—®å¯†åº¦é«˜ï¼ˆ0.3/å¤©+ï¼‰        â”‚    â”‚ â†’ è‡ªåŠ¨åˆ é™¤ ğŸ—‘ï¸
    â”‚ å­˜æ´»30å¤©+                    â”‚    â”‚
    â†“                             â”‚    â”‚
[longTerm] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”
    â”‚                             â”‚    â”‚    â”‚
    â”‚ 90å¤©ä¸æ´»è·ƒ + ä½ä»·å€¼          â”‚    â”‚    â”‚ 365å¤©è¿‡æœŸ + ä½ä»·å€¼
    â”‚ â†’ é™çº§                       â”‚    â”‚    â”‚ â†’ è‡ªåŠ¨åˆ é™¤ ğŸ—‘ï¸
    â†“                             â”‚    â”‚    â”‚
[midTerm] â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚    â”‚
    â”‚                                  â”‚    â”‚
    â”‚ 30å¤©ä¸æ´»è·ƒ + ä½ä»·å€¼               â”‚    â”‚
    â”‚ â†’ é™çº§                            â”‚    â”‚
    â†“                                  â”‚    â”‚
[shortTerm] â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
    â”‚                                       â”‚
    â”‚ 30å¤©è¿‡æœŸ + ä½ä»·å€¼                      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ åˆ é™¤ ğŸ—‘ï¸ â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“Š è‡ªåŠ¨æ¸…ç†ç¤ºä¾‹

### åœºæ™¯1ï¼šæ™®é€šçŸ­æœŸè®°å¿†

```
Day 0:  åˆ›å»ºshortTerm "ä»Šå¤©åƒäº†åˆé¥­"
        é‡è¦æ€§: 0.2, è®¿é—®: 1æ¬¡

Day 15: å¶å°”è®¿é—®ä¸€æ¬¡
        è®¿é—®: 2æ¬¡

Day 35: âš ï¸ è§¦å‘æ·˜æ±°è§„åˆ™
        å¹´é¾„35å¤© > 30å¤©é˜ˆå€¼
        é‡è¦æ€§0.2 > 0.1é˜ˆå€¼
        â†’ ä¿ç•™ï¼ˆé‡è¦æ€§ä¸å¤Ÿä½ï¼‰

Day 40: é‡è¦æ€§è¡°å‡åˆ°0.08
        å¹´é¾„40å¤© > 30å¤©
        é‡è¦æ€§0.08 < 0.1
        â†’ ğŸ—‘ï¸ è‡ªåŠ¨åˆ é™¤
```

### åœºæ™¯2ï¼šé«˜é¢‘ä½¿ç”¨è®°å¿†

```
Day 0:  åˆ›å»ºshortTerm "é¡¹ç›®æ¶æ„è®¾è®¡"
        é‡è¦æ€§: 0.6, è®¿é—®: 1æ¬¡

Day 7:  é¢‘ç¹è®¿é—®ï¼ˆ15æ¬¡ï¼‰
        è®¿é—®å¯†åº¦: 15/7 = 2.1æ¬¡/å¤© > 0.5é˜ˆå€¼
        â†’ âœ… è‡ªåŠ¨å‡çº§åˆ°midTerm

Day 40: æŒç»­é«˜é¢‘è®¿é—®ï¼ˆ60æ¬¡ï¼‰
        è®¿é—®å¯†åº¦: 60/40 = 1.5æ¬¡/å¤© > 0.3é˜ˆå€¼
        â†’ âœ… è‡ªåŠ¨å‡çº§åˆ°longTerm

Day 180: 3ä¸ªæœˆæœªè®¿é—®
         ä¸æ´»è·ƒå¤©æ•°: 90å¤©
         é‡è¦æ€§: 0.6 > 0.5é˜ˆå€¼
         â†’ ä¿ç•™ä¸ºlongTermï¼ˆä»ç„¶é‡è¦ï¼‰

Day 300: é‡è¦æ€§è¡°å‡åˆ°0.4
         ä¸æ´»è·ƒå¤©æ•°: 210å¤© > 90å¤©
         é‡è¦æ€§: 0.4 < 0.5é˜ˆå€¼
         â†’ â¬‡ï¸ é™çº§åˆ°midTerm

Day 400: ç»§ç»­ä¸æ´»è·ƒ
         ä¸æ´»è·ƒå¤©æ•°: 310å¤© > 30å¤©
         é‡è¦æ€§: 0.4 > 0.3é˜ˆå€¼
         â†’ ä¿ç•™ä¸ºmidTermï¼ˆè¿˜ä¸å¤Ÿä½ï¼‰

Day 500: é‡è¦æ€§ç»§ç»­è¡°å‡åˆ°0.15
         å¹´é¾„: 500å¤© > 90å¤©
         é‡è¦æ€§: 0.15 < 0.2é˜ˆå€¼
         â†’ ğŸ—‘ï¸ è‡ªåŠ¨åˆ é™¤
```

### åœºæ™¯3ï¼šé‡è¦é•¿æœŸè®°å¿†

```
Day 0:   åˆ›å»ºlongTerm "å…¬å¸æ ¸å¿ƒä»·å€¼è§‚"
         é‡è¦æ€§: 0.9 (pinnedç±»å‹)

Day 365: 1å¹´è¿‡æœŸ
         â†’ âœ… ä¿ç•™ï¼ˆpinnedç±»å‹æ°¸ä¸åˆ é™¤ï¼‰

Day 730: 2å¹´è¿‡æœŸ
         â†’ âœ… ä»ç„¶ä¿ç•™

ç»“è®ºï¼špinnedå’Œprofileç±»å‹æ°¸ä¹…ä¿å­˜
```

## ğŸ¯ è§„æ¨¡æ§åˆ¶æ•ˆæœ

### ç†è®ºä¸Šé™è®¡ç®—

å‡è®¾ç”¨æˆ·æ¯å¤©äº§ç”Ÿ10æ¡æ–°è®°å¿†ï¼š

```
shortTermæœ€å¤šå­˜æ´»:  30å¤©  Ã— 10æ¡/å¤© = 300æ¡
midTermæœ€å¤šå­˜æ´»:    90å¤©  Ã— 10æ¡/å¤© = 900æ¡
longTermæœ€å¤šå­˜æ´»:   365å¤© Ã— 10æ¡/å¤© = 3650æ¡

ç†è®ºæœ€å¤§å€¼: 4850æ¡è®°å¿†
```

### å®é™…è§„æ¨¡æ§åˆ¶

ç”±äº**å‡çº§è¿‡æ»¤**å’Œ**è‡ªåŠ¨æ·˜æ±°**ï¼š

```
å®é™…shortTerm: ~100-200æ¡
  - 90%è¢«æ·˜æ±°ï¼ˆä½ä»·å€¼ï¼‰
  - 10%å‡çº§åˆ°midTerm

å®é™…midTerm: ~300-500æ¡
  - 70%è¢«æ·˜æ±°
  - 20%å‡çº§åˆ°longTerm
  - 10%é™çº§å›shortTerm

å®é™…longTerm: ~500-1000æ¡
  - åªæœ‰é«˜ä»·å€¼ã€é«˜é¢‘è®¿é—®çš„è®°å¿†
  - ä¸æ´»è·ƒçš„ä¼šé™çº§

å®é™…æ€»é‡: çº¦1000-1700æ¡è®°å¿†
```

## âš™ï¸ é…ç½®ç¤ºä¾‹

### æ¿€è¿›æ¸…ç†ï¼ˆèŠ‚çœç©ºé—´ï¼‰

```typescript
memoryLifecycleManager.updateConfig({
  deletion: {
    shortTerm: {
      maxAge: 7 * 24 * 60 * 60 * 1000,    // 7å¤©å°±åˆ é™¤
      minImportance: 0.3                   // é‡è¦æ€§<0.3å°±åˆ 
    },
    midTerm: {
      maxAge: 30 * 24 * 60 * 60 * 1000,   // 30å¤©åˆ é™¤
      minImportance: 0.4
    },
    longTerm: {
      maxAge: 180 * 24 * 60 * 60 * 1000,  // 180å¤©åˆ é™¤
      minImportance: 0.5
    }
  },
  evaluationInterval: 6 * 60 * 60 * 1000   // æ¯6å°æ—¶æ¸…ç†ä¸€æ¬¡
});
```

**æ•ˆæœ**ï¼šè®°å¿†æ€»é‡æ§åˆ¶åœ¨~500æ¡ä»¥å†…

### ä¿å®ˆæ¸…ç†ï¼ˆä¿ç•™æ›´å¤šï¼‰

```typescript
memoryLifecycleManager.updateConfig({
  deletion: {
    shortTerm: {
      maxAge: 60 * 24 * 60 * 60 * 1000,   // 60å¤©
      minImportance: 0.05
    },
    midTerm: {
      maxAge: 180 * 24 * 60 * 60 * 1000,  // 180å¤©
      minImportance: 0.1
    },
    longTerm: {
      maxAge: 730 * 24 * 60 * 60 * 1000,  // 2å¹´
      minImportance: 0.2
    }
  }
});
```

**æ•ˆæœ**ï¼šè®°å¿†æ€»é‡å¯èƒ½è¾¾åˆ°~3000æ¡

## ğŸ“ˆ ç›‘æ§è®°å¿†è§„æ¨¡

### å®æ—¶æŸ¥çœ‹ç»Ÿè®¡

```typescript
const stats = enhancedMemoryManager.getLifecycleStats(userId);

console.log(`æ€»è®°å¿†æ•°: ${stats.totalCount}`);
console.log(`shortTerm: ${stats.byType.shortTerm} æ¡`);
console.log(`midTerm: ${stats.byType.midTerm} æ¡`);
console.log(`longTerm: ${stats.byType.longTerm} æ¡`);
console.log(`å¹³å‡å¹´é¾„: ${stats.averageAge.shortTerm.toFixed(1)} å¤©`);
```

### è®¾ç½®å‘Šè­¦é˜ˆå€¼

```typescript
// æ£€æŸ¥æ˜¯å¦è¶…è¿‡é˜ˆå€¼
const MAX_MEMORIES = 2000;
if (stats.totalCount > MAX_MEMORIES) {
  console.warn(`âš ï¸ è®°å¿†æ•°é‡ ${stats.totalCount} è¶…è¿‡é˜ˆå€¼ ${MAX_MEMORIES}`);

  // ç«‹å³æ‰§è¡Œæ¸…ç†
  await enhancedMemoryManager.evaluateMemoryLifecycle(userId);
}
```

## ğŸ”§ æ‰‹åŠ¨æ¸…ç†

### æŒ‰éœ€æ¸…ç†

```typescript
// ç«‹å³è¯„ä¼°å¹¶æ¸…ç†
const result = await enhancedMemoryManager.evaluateMemoryLifecycle(userId);

console.log(`åˆ é™¤äº† ${result.deleted} æ¡è®°å¿†`);
console.log(`å‡çº§äº† ${result.upgraded} æ¡è®°å¿†`);
console.log(`é™çº§äº† ${result.downgraded} æ¡è®°å¿†`);
```

### æ‰¹é‡æ¸…ç†æ‰€æœ‰ç”¨æˆ·

```typescript
import { memoryLifecycleManager } from "./dist/memory/memory-lifecycle-manager.js";

// è¯„ä¼°æ‰€æœ‰ç”¨æˆ·
const results = await memoryLifecycleManager.evaluateAllUsers();

let totalDeleted = 0;
for (const [userId, result] of results) {
  totalDeleted += result.deleted;
  console.log(`${userId}: åˆ é™¤ ${result.deleted} æ¡`);
}

console.log(`æ€»å…±åˆ é™¤: ${totalDeleted} æ¡è®°å¿†`);
```

## ğŸ›¡ï¸ æ•°æ®å®‰å…¨ä¿æŠ¤

### æ°¸ä¸åˆ é™¤çš„è®°å¿†ç±»å‹

```typescript
// pinned - ç”¨æˆ·æ˜ç¡®æ ‡è®°çš„é‡è¦è®°å¿†
// profile - ç”¨æˆ·ä¸ªäººä¿¡æ¯

// è¿™ä¸¤ç§ç±»å‹ä¸å‚ä¸æ·˜æ±°æœºåˆ¶
```

### åˆ é™¤å‰å¤‡ä»½ï¼ˆå¯é€‰ï¼‰

```typescript
// æ‰©å±•åˆ é™¤æ–¹æ³•ï¼Œæ·»åŠ å¤‡ä»½é€»è¾‘
import fs from "fs";

const originalDelete = vectorMemoryStore.removeMemory.bind(vectorMemoryStore);

vectorMemoryStore.removeMemory = function(memoryId: string) {
  const memory = this.getMemoryById(memoryId);

  if (memory) {
    // å¤‡ä»½åˆ°å½’æ¡£æ–‡ä»¶
    const archivePath = `./archives/${memory.metadata.userId}/deleted.jsonl`;
    fs.appendFileSync(
      archivePath,
      JSON.stringify({
        ...memory,
        deletedAt: Date.now()
      }) + "\n"
    );
  }

  return originalDelete(memoryId);
};
```

## ğŸ“Š æ€§èƒ½å½±å“

### å®šæœŸè¯„ä¼°å¼€é”€

```
æ¯æ¬¡è¯„ä¼°:
- è¯»å–æ‰€æœ‰è®°å¿†: O(n)
- é€æ¡è¯„ä¼°: O(n)
- æ›´æ–°æ“ä½œ: O(m) (mä¸ºå˜æ›´æ•°é‡)

æ€»æ—¶é—´å¤æ‚åº¦: O(n)

å®æµ‹æ•°æ®ï¼ˆ1000æ¡è®°å¿†ï¼‰:
- è¯„ä¼°è€—æ—¶: ~100ms
- æ›´æ–°è€—æ—¶: ~50ms
- æ€»è€—æ—¶: <200ms
```

### ä¼˜åŒ–å»ºè®®

```typescript
// 1. é™ä½è¯„ä¼°é¢‘ç‡ï¼ˆå¦‚æœè®°å¿†å¢é•¿æ…¢ï¼‰
evaluationInterval: 48 * 60 * 60 * 1000  // 48å°æ—¶

// 2. åªåœ¨å¤œé—´è¯„ä¼°
const hour = new Date().getHours();
if (hour >= 2 && hour <= 4) {  // å‡Œæ™¨2-4ç‚¹
  await evaluateMemoryLifecycle(userId);
}

// 3. åˆ†æ‰¹å¤„ç†å¤§é‡ç”¨æˆ·
const users = getAllUserIds();
for (let i = 0; i < users.length; i++) {
  await evaluateMemoryLifecycle(users[i]);
  if (i % 100 === 0) {
    await new Promise(resolve => setTimeout(resolve, 1000));  // æ¯100ä¸ªç”¨æˆ·æš‚åœ1ç§’
  }
}
```

## æ€»ç»“

JPClawçš„è®°å¿†è§„æ¨¡æ§åˆ¶é€šè¿‡ï¼š

âœ… **è‡ªåŠ¨å‡çº§** - è¯†åˆ«å¹¶ä¿ç•™é«˜ä»·å€¼è®°å¿†
âœ… **è‡ªåŠ¨é™çº§** - æ·¡åŒ–ä¸å¸¸ç”¨è®°å¿†
âœ… **è‡ªåŠ¨æ·˜æ±°** - åˆ é™¤ä½ä»·å€¼è¿‡æœŸè®°å¿†
âœ… **å®šæœŸè¯„ä¼°** - åå°è‡ªåŠ¨æ¸…ç†ï¼ˆé»˜è®¤24å°æ—¶ï¼‰
âœ… **çµæ´»é…ç½®** - æ ¹æ®éœ€æ±‚è°ƒæ•´ç­–ç•¥
âœ… **å®‰å…¨ä¿æŠ¤** - é‡è¦è®°å¿†æ°¸ä¸åˆ é™¤

**ç»“æœ**ï¼šè®°å¿†æ€»é‡è‡ªåŠ¨ç»´æŒåœ¨åˆç†èŒƒå›´ï¼ˆ~1000-2000æ¡ï¼‰ï¼Œæ— éœ€äººå·¥å¹²é¢„ã€‚
