<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JPClaw Dashboard</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
      background: #0a0a0a;
      color: #e0e0e0;
      padding: 20px;
      line-height: 1.6;
    }

    .container { max-width: 1200px; margin: 0 auto; }

    /* é¡¶éƒ¨è¿›åº¦æ¡ï¼ˆå€’è®¡æ—¶åˆ·æ–°ï¼‰ */
    .refresh-bar {
      position: fixed;
      top: 0; left: 0;
      height: 3px;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      transition: width 1s linear;
      z-index: 100;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding: 24px 0 20px;
      border-bottom: 2px solid #333;
      margin-bottom: 24px;
      flex-wrap: wrap;
      gap: 12px;
    }

    .header-left h1 {
      font-size: 1.8em;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 4px;
    }

    .header-left .uptime {
      font-size: 0.85em;
      color: #666;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 0.85em;
      font-weight: 600;
      letter-spacing: 0.5px;
    }

    .status-badge .dot { width: 8px; height: 8px; border-radius: 50%; }

    .status-healthy  { background: rgba(16,185,129,.15); color: #10b981; border: 1px solid rgba(16,185,129,.3); }
    .status-healthy .dot  { background: #10b981; box-shadow: 0 0 6px #10b981; }
    .status-degraded { background: rgba(245,158,11,.15); color: #f59e0b; border: 1px solid rgba(245,158,11,.3); }
    .status-degraded .dot { background: #f59e0b; box-shadow: 0 0 6px #f59e0b; }
    .status-unhealthy{ background: rgba(239,68,68,.15);  color: #ef4444; border: 1px solid rgba(239,68,68,.3); }
    .status-unhealthy .dot{ background: #ef4444; box-shadow: 0 0 6px #ef4444; }
    .status-unknown  { background: rgba(107,114,128,.15);color: #9ca3af; border: 1px solid rgba(107,114,128,.3); }
    .status-unknown .dot  { background: #9ca3af; }

    .btn {
      background: transparent;
      color: #667eea;
      border: 1px solid #667eea;
      padding: 6px 14px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85em;
      transition: all 0.2s;
      text-decoration: none;
      display: inline-block;
    }
    .btn:hover { background: rgba(102,126,234,.15); }
    .btn-primary { background: #667eea; color: white; border-color: #667eea; }
    .btn-primary:hover { background: #5568d3; }
    .btn:disabled { background: #333; color: #555; border-color: #444; cursor: not-allowed; }

    .refresh-info {
      font-size: 0.8em;
      color: #666;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* â”€â”€ æŒ‡æ ‡å¡ â”€â”€ */
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .metric-card {
      background: #1a1a1a;
      padding: 20px;
      border-radius: 12px;
      border: 1px solid #333;
      transition: all 0.2s;
    }
    .metric-card:hover { border-color: #667eea; box-shadow: 0 4px 12px rgba(102,126,234,.15); }

    .metric-icon   { font-size: 1.3em; margin-bottom: 8px; }
    .metric-label  { font-size: 0.8em; color: #888; text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 6px; }
    .metric-value  { font-size: 2em; font-weight: 700; color: #fff; line-height: 1.1; }
    /* æœ€ç®€å•çš„ä¸­æ–‡å¤‡æ³¨ï¼šæŒ‡æ ‡å«ä¹‰è¯´æ˜ */
    .metric-hint   { font-size: 0.75em; color: #555; margin-top: 5px; line-height: 1.4; }

    /* â”€â”€ é€šç”¨åŒºå— â”€â”€ */
    .section {
      background: #1a1a1a;
      border-radius: 12px;
      border: 1px solid #333;
      margin-bottom: 20px;
      overflow: hidden;
    }

    .section-header {
      padding: 14px 20px;
      border-bottom: 1px solid #2a2a2a;
      font-size: 1em;
      font-weight: 600;
      color: #fff;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .section-header-meta {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 400;
    }

    .section-note { font-size: 0.78em; color: #555; font-weight: 400; }

    /* â”€â”€ ä»£ç è´¨é‡ Benchmark æ‘˜è¦ â”€â”€ */
    .bm-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 0;
    }

    .bm-cell {
      padding: 16px 20px;
      border-right: 1px solid #222;
      border-bottom: 1px solid #222;
    }
    .bm-cell:last-child { border-right: none; }

    .bm-label { font-size: 0.75em; color: #666; margin-bottom: 4px; }
    .bm-value { font-size: 1.5em; font-weight: 700; color: #fff; }
    .bm-hint  { font-size: 0.72em; color: #555; margin-top: 3px; }

    /* ç­‰çº§è‰² */
    .grade-A { color: #10b981; }
    .grade-B { color: #3b82f6; }
    .grade-C { color: #f59e0b; }
    .grade-D { color: #ef4444; }

    .grade-badge {
      font-size: 0.9em;
      font-weight: 700;
      padding: 2px 10px;
      border-radius: 10px;
    }
    .badge-A { background: rgba(16,185,129,.15); color: #10b981; border: 1px solid rgba(16,185,129,.3); }
    .badge-B { background: rgba(59,130,246,.15);  color: #3b82f6; border: 1px solid rgba(59,130,246,.3); }
    .badge-C { background: rgba(245,158,11,.15); color: #f59e0b; border: 1px solid rgba(245,158,11,.3); }
    .badge-D { background: rgba(239,68,68,.15);  color: #ef4444; border: 1px solid rgba(239,68,68,.3); }

    /* è¿·ä½ è¿›åº¦æ¡ */
    .mini-bar {
      height: 4px;
      background: #2a2a2a;
      border-radius: 2px;
      margin-top: 6px;
      overflow: hidden;
    }
    .mini-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      border-radius: 2px;
      transition: width 0.5s ease;
    }

    /* â”€â”€ å®šæ—¶ä»»åŠ¡è¡¨ â”€â”€ */
    .task-table { width: 100%; border-collapse: collapse; }
    .task-table th {
      padding: 10px 20px;
      text-align: left;
      font-size: 0.78em;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 500;
      border-bottom: 1px solid #2a2a2a;
    }
    .task-table td {
      padding: 12px 20px;
      font-size: 0.9em;
      border-bottom: 1px solid #222;
    }
    .task-table tr:last-child td { border-bottom: none; }
    .task-table tr.paused td { color: #555; font-style: italic; }

    .task-name { font-weight: 500; }
    .task-time       { color: #aaa; font-size: 0.85em; }
    .task-time-empty { color: #444; }

    .task-badge {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 2px 10px;
      border-radius: 12px;
      font-size: 0.8em;
      font-weight: 500;
    }
    .task-active  { background: rgba(16,185,129,.12); color: #10b981; border: 1px solid rgba(16,185,129,.25); }
    .task-paused  { background: rgba(107,114,128,.12);color: #6b7280; border: 1px solid rgba(107,114,128,.25); }
    .task-running { background: rgba(102,126,234,.15); color: #667eea; border: 1px solid rgba(102,126,234,.3); }
    .task-error   { background: rgba(239,68,68,.12);  color: #ef4444; border: 1px solid rgba(239,68,68,.25); }

    /* â”€â”€ å¥åº·æ£€æŸ¥ â”€â”€ */
    .check-list { padding: 4px 0; }

    .check-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 20px;
      border-bottom: 1px solid #222;
      transition: background 0.1s;
    }
    .check-item:last-child { border-bottom: none; }
    .check-item:hover { background: rgba(255,255,255,.02); }

    .check-left { display: flex; align-items: center; gap: 10px; }

    .check-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
    .dot-healthy   { background: #10b981; box-shadow: 0 0 5px rgba(16,185,129,.5); }
    .dot-degraded  { background: #f59e0b; box-shadow: 0 0 5px rgba(245,158,11,.5); }
    .dot-unhealthy { background: #ef4444; box-shadow: 0 0 5px rgba(239,68,68,.5); }
    .dot-unknown   { background: #6b7280; }

    .check-name-wrap { display: flex; flex-direction: column; gap: 1px; }
    /* è‹±æ–‡æŠ€æœ¯å */
    .check-name {
      font-size: 0.88em;
      font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
      color: #ccc;
    }
    /* ä¸­æ–‡å¤‡æ³¨ */
    .check-cn { font-size: 0.75em; color: #555; }

    .check-right {
      display: flex;
      align-items: center;
      gap: 16px;
      font-size: 0.82em;
      color: #777;
    }
    .check-status-text.healthy   { color: #10b981; }
    .check-status-text.degraded  { color: #f59e0b; }
    .check-status-text.unhealthy { color: #ef4444; }

    /* â”€â”€ é€šç”¨å ä½/é”™è¯¯ â”€â”€ */
    .placeholder {
      padding: 32px 20px;
      text-align: center;
      color: #555;
      font-size: 0.9em;
    }

    .error-bar {
      background: rgba(239,68,68,.1);
      border: 1px solid rgba(239,68,68,.3);
      color: #ef4444;
      padding: 12px 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 0.9em;
    }

    @media (max-width: 640px) {
      .task-table th:nth-child(3),
      .task-table td:nth-child(3) { display: none; }
      header { flex-direction: column; }
      .bm-grid { grid-template-columns: repeat(2, 1fr); }
    }
  </style>
</head>
<body>
  <div class="refresh-bar" id="refreshBar"></div>
  <div class="container">

    <header>
      <div class="header-left">
        <h1>ğŸ¤– JPClaw Dashboard</h1>
        <!-- ä¸­æ–‡å¤‡æ³¨ï¼šæœåŠ¡æŒç»­è¿è¡Œæ—¶é•¿ -->
        <div class="uptime" id="uptimeText">æ­£åœ¨åŠ è½½...</div>
      </div>
      <div class="header-right">
        <span class="status-badge status-unknown" id="overallBadge">
          <span class="dot"></span>
          <span id="overallText">â€“</span>
        </span>
        <div class="refresh-info">
          <span id="countdownText">â€“</span>
          <button class="btn btn-primary" onclick="refresh()">ç«‹å³åˆ·æ–°</button>
        </div>
        <a class="btn" href="/dashboard/benchmark">Benchmark</a>
      </div>
    </header>

    <div id="errorBar" style="display:none" class="error-bar"></div>

    <!-- â‘  4 ä¸ªè¿è¡Œæ—¶æŒ‡æ ‡å¡ -->
    <div class="metrics-grid">
      <div class="metric-card">
        <div class="metric-icon">ğŸ“Š</div>
        <div class="metric-label">æ€»è¯·æ±‚æ•°</div>
        <div class="metric-value" id="totalRequests">â€“</div>
        <!-- ä¸­æ–‡å¤‡æ³¨ -->
        <div class="metric-hint">è‡ªæœåŠ¡å¯åŠ¨è‡³ä»Šï¼Œç»ç½‘å…³å¤„ç†çš„ç´¯è®¡è¯·æ±‚æ¬¡æ•°</div>
      </div>
      <div class="metric-card">
        <div class="metric-icon">âš¡</div>
        <div class="metric-label">é”™è¯¯ç‡</div>
        <div class="metric-value" id="errorRate">â€“</div>
        <div class="metric-hint">é”™è¯¯å“åº”å æ€»è¯·æ±‚çš„ç™¾åˆ†æ¯”ï¼Œè¶…è¿‡ 5% éœ€å…³æ³¨</div>
      </div>
      <div class="metric-card">
        <div class="metric-icon">â±</div>
        <div class="metric-label">å¹³å‡å“åº”æ—¶é—´</div>
        <div class="metric-value" id="avgResponseTime">â€“</div>
        <div class="metric-hint">æ‰€æœ‰è¯·æ±‚çš„å¹³å‡ç«¯åˆ°ç«¯å¤„ç†è€—æ—¶ï¼ˆæ¯«ç§’ï¼‰</div>
      </div>
      <div class="metric-card">
        <div class="metric-icon">ğŸ’¾</div>
        <div class="metric-label">å †å†…å­˜</div>
        <div class="metric-value" id="memoryUsage">â€“</div>
        <!-- heapTotal å‹åŠ›æ¡ï¼šheapUsed/heapTotalï¼Œæ¥è¿‘ 100% è¯´æ˜ V8 æ­£åœ¨æ‰©å † -->
        <div class="mini-bar" style="margin-top:8px">
          <div class="mini-bar-fill" id="heapPressureBar" style="width:0%"></div>
        </div>
        <div id="memoryDetail" class="metric-hint" style="margin-top:5px">â€“</div>
      </div>
    </div>

    <!-- â‘¡ ä»£ç è´¨é‡ï¼ˆBenchmark æ‘˜è¦ï¼‰ -->
    <div class="section">
      <div class="section-header">
        ğŸ§ª ä»£ç è´¨é‡
        <span class="section-note">æœ€è¿‘ä¸€æ¬¡ Benchmark æ‘˜è¦</span>
        <div class="section-header-meta" id="bmMeta" style="display:none">
          <span id="bmGradeBadge"></span>
          <span id="bmTimestamp" style="font-size:0.78em;color:#555;"></span>
          <a class="btn" href="/dashboard/benchmark" style="padding:3px 10px;font-size:0.8em;">æŸ¥çœ‹è¯¦æƒ…</a>
        </div>
      </div>
      <div id="bmContent">
        <div class="placeholder">æ­£åœ¨åŠ è½½...</div>
      </div>
    </div>

    <!-- â‘¢ å®šæ—¶ä»»åŠ¡ -->
    <div class="section">
      <div class="section-header">ğŸ—“ å®šæ—¶ä»»åŠ¡</div>
      <div id="tasksContent">
        <div class="placeholder">æ­£åœ¨åŠ è½½...</div>
      </div>
    </div>

    <!-- â‘£ å¥åº·æ£€æŸ¥ -->
    <div class="section">
      <div class="section-header">ğŸ¥ å¥åº·æ£€æŸ¥</div>
      <div id="checksContent">
        <div class="placeholder">æ­£åœ¨åŠ è½½...</div>
      </div>
    </div>

  </div>

  <script>
    const REFRESH_INTERVAL = 30;
    let countdown = REFRESH_INTERVAL;
    let countdownTimer = null;

    // â”€â”€ å¥åº·æ£€æŸ¥åç§°ä¸­æ–‡æ˜ å°„ â”€â”€
    const CHECK_CN = {
      memory:            'V8 å †å†…å­˜',
      system_memory:     'ç³»ç»Ÿ RAM',
      disk:              'ç£ç›˜ç©ºé—´',
      event_loop:        'äº‹ä»¶å¾ªç¯å»¶è¿Ÿ',
      provider_anthropic:'Anthropic API è¿é€šæ€§',
      provider_openai:   'OpenAI API è¿é€šæ€§',
      sessions_storage:  'ä¼šè¯æ–‡ä»¶å­˜å‚¨',
      vector_memory:     'å‘é‡è®°å¿†åº“',
      conflict_resolver: 'è®°å¿†å†²çªè§£å†³å™¨',
    };

    // â”€â”€ å·¥å…·å‡½æ•° â”€â”€
    function pad(n) { return String(n).padStart(2, '0'); }

    function fmtMB(bytes) {
      if (bytes == null) return 'â€“';
      return Math.round(bytes / 1024 / 1024) + ' MB';
    }

    function fmtNum(n) {
      if (n == null) return 'â€“';
      return Number(n).toLocaleString('zh-CN');
    }

    function escHtml(s) {
      return String(s)
        .replace(/&/g, '&amp;').replace(/</g, '&lt;')
        .replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    function formatTime(d) {
      const now = new Date();
      const isToday    = d.toDateString() === now.toDateString();
      const isTomorrow = new Date(now.getTime() + 86400000).toDateString() === d.toDateString();
      const prefix = isToday ? 'ä»Šæ—¥' : isTomorrow ? 'æ˜æ—¥'
                   : (d.getMonth()+1) + '/' + d.getDate();
      return prefix + ' ' + pad(d.getHours()) + ':' + pad(d.getMinutes());
    }

    // ç›¸å¯¹æ—¶é—´ï¼š"2å°æ—¶å‰" / "æ˜¨æ—¥ 08:00" / "â”€"
    function timeAgo(isoStr) {
      if (!isoStr) return '<span class="task-time-empty">â”€</span>';
      const d = new Date(isoStr);
      if (isNaN(d.getTime())) return '<span class="task-time-empty">â”€</span>';
      const diff = Date.now() - d.getTime();
      if (diff < 0) return '<span class="task-time">' + formatTime(d) + '</span>';
      const mins  = Math.floor(diff / 60000);
      const hours = Math.floor(diff / 3600000);
      const days  = Math.floor(diff / 86400000);
      if (mins  <  1) return '<span class="task-time">åˆšåˆš</span>';
      if (mins  < 60) return '<span class="task-time">' + mins + ' åˆ†é’Ÿå‰</span>';
      if (hours < 24) return '<span class="task-time">' + hours + ' å°æ—¶å‰</span>';
      if (days  === 1) return '<span class="task-time">æ˜¨æ—¥ ' + pad(d.getHours()) + ':' + pad(d.getMinutes()) + '</span>';
      return '<span class="task-time">' + formatTime(d) + '</span>';
    }

    function timeFromNow(isoStr) {
      if (!isoStr) return '<span class="task-time-empty">â”€</span>';
      const d = new Date(isoStr);
      if (isNaN(d.getTime())) return '<span class="task-time-empty">â”€</span>';
      return '<span class="task-time">' + formatTime(d) + '</span>';
    }

    function taskBadge(status) {
      if (status === 'active')  return '<span class="task-badge task-active">ğŸŸ¢ active</span>';
      if (status === 'paused')  return '<span class="task-badge task-paused">â¸ paused</span>';
      if (status === 'running') return '<span class="task-badge task-running">âš¡ running</span>';
      if (status === 'error')   return '<span class="task-badge task-error">âŒ error</span>';
      return '<span class="task-badge task-paused">' + escHtml(status || 'â€“') + '</span>';
    }

    function overallClass(s) {
      return s === 'healthy' ? 'status-healthy'
           : s === 'degraded'? 'status-degraded'
           : s === 'unhealthy'? 'status-unhealthy'
           : 'status-unknown';
    }

    function checkDotClass(s) {
      return s === 'healthy' ? 'dot-healthy'
           : s === 'degraded'? 'dot-degraded'
           : s === 'unhealthy'? 'dot-unhealthy'
           : 'dot-unknown';
    }

    function statusCN(s) {
      return s === 'healthy'   ? 'æ­£å¸¸'
           : s === 'degraded'  ? 'å‘Šè­¦'
           : s === 'unhealthy' ? 'å¼‚å¸¸'
           : s || 'â€“';
    }

    function gradeBadgeHtml(g) {
      const cls = { A:'badge-A', B:'badge-B', C:'badge-C', D:'badge-D' }[g] || 'badge-D';
      return '<span class="grade-badge ' + cls + '">' + g + ' çº§</span>';
    }

    // â”€â”€ æ¸²æŸ“å‡½æ•° â”€â”€

    function renderHeader(health) {
      const badge = document.getElementById('overallBadge');
      badge.className = 'status-badge ' + overallClass(health.overall);
      document.getElementById('overallText').textContent =
        { healthy:'HEALTHY', degraded:'DEGRADED', unhealthy:'UNHEALTHY' }[health.overall]
        || health.overall.toUpperCase();
      document.getElementById('uptimeText').textContent =
        'æŒç»­è¿è¡Œï¼š' + (health.uptimeFormatted || 'â€“');
    }

    function renderMetrics(m) {
      document.getElementById('totalRequests').textContent = fmtNum(m.totalRequests);
      document.getElementById('errorRate').textContent =
        m.errorRate != null ? m.errorRate.toFixed(2) + '%' : 'â€“';
      document.getElementById('avgResponseTime').textContent =
        m.avgResponseTime != null ? Math.round(m.avgResponseTime) + ' ms' : 'â€“';
      // å†…å­˜å¡ç”± renderMemoryCard() è´Ÿè´£ï¼Œæ•°æ®æ¥è‡ª health check details
    }

    // å†…å­˜å¡å•ç‹¬æ¸²æŸ“ï¼Œä½¿ç”¨ health.checks.memory.detailsï¼ˆå« heapMaxMB çœŸå®ä¸Šé™ï¼‰
    function renderMemoryCard(checks) {
      const mc = checks && checks.memory;
      const d  = mc && mc.details;
      if (!d) {
        document.getElementById('memoryUsage').textContent = 'â€“';
        return;
      }
      const { heapUsedMB, heapTotalMB, rssMB, heapMaxMB, heapUsedPct } = d;

      document.getElementById('memoryUsage').textContent = heapUsedMB + ' MB';

      // å‹åŠ›æ¡ï¼šheapUsed / heapMaxï¼ˆ512MBï¼‰ï¼Œè¿™æ‰æ˜¯çœŸå®ä¸Šé™
      const bar = document.getElementById('heapPressureBar');
      bar.style.width = heapUsedPct + '%';
      bar.style.background =
        heapUsedPct > 85 ? '#ef4444'
        : heapUsedPct > 70 ? '#f59e0b'
        : 'linear-gradient(90deg, #667eea 0%, #764ba2 100%)';

      // æ˜ç»†ï¼šheapUsed/heapMaxï¼ˆçœŸå®å‹åŠ›ï¼‰+ V8å½“å‰åˆ†é…ï¼ˆheapTotalï¼Œçœ‹æ‰©å †çŠ¶æ€ï¼‰+ è¿›ç¨‹æ€»å†…å­˜(rss)
      document.getElementById('memoryDetail').textContent =
        'ä¸Šé™å‹åŠ› ' + heapUsedMB + '/' + heapMaxMB + ' MB (' + heapUsedPct + '%)' +
        ' Â· V8åˆ†é… ' + heapTotalMB + ' MB Â· è¿›ç¨‹ ' + rssMB + ' MB';
    }

    function renderTasks(tasks) {
      const el = document.getElementById('tasksContent');
      if (!tasks || tasks.length === 0) {
        el.innerHTML = '<div class="placeholder">æš‚æ— å®šæ—¶ä»»åŠ¡</div>';
        return;
      }
      const rows = tasks.map(t => {
        const isPaused = t.status === 'paused';
        return '<tr class="' + (isPaused ? 'paused' : '') + '">' +
          '<td class="task-name">' + escHtml(t.name || t.id) + '</td>' +
          '<td>' + timeAgo(t.lastRunAt) + '</td>' +
          '<td>' + timeFromNow(t.nextRunAt) + '</td>' +
          '<td>' + taskBadge(t.status) + '</td>' +
          '</tr>';
      }).join('');
      el.innerHTML =
        '<table class="task-table"><thead><tr>' +
        '<th>åç§°</th><th>ä¸Šæ¬¡è¿è¡Œ</th><th>ä¸‹æ¬¡è¿è¡Œ</th><th>çŠ¶æ€</th>' +
        '</tr></thead><tbody>' + rows + '</tbody></table>';
    }

    function renderChecks(checks) {
      const el = document.getElementById('checksContent');
      const entries = Object.entries(checks || {});
      if (entries.length === 0) {
        el.innerHTML = '<div class="placeholder">æš‚æ— å¥åº·æ£€æŸ¥</div>';
        return;
      }
      const items = entries.map(([name, result]) => {
        const cnName = CHECK_CN[name] || '';
        const detail = formatCheckDetail(name, result);
        return '<div class="check-item">' +
          '<div class="check-left">' +
          '<span class="check-dot ' + checkDotClass(result.status) + '"></span>' +
          '<div class="check-name-wrap">' +
          '<span class="check-name">' + escHtml(name) + '</span>' +
          (cnName ? '<span class="check-cn">' + cnName + '</span>' : '') +
          '</div>' +
          '</div>' +
          '<div class="check-right">' +
          (detail ? '<span>' + detail + '</span>' : '') +
          (result.duration != null ? '<span>' + result.duration + 'ms</span>' : '') +
          '<span class="check-status-text ' + result.status + '">' + statusCN(result.status) + '</span>' +
          '</div>' +
          '</div>';
      }).join('');
      el.innerHTML = '<div class="check-list">' + items + '</div>';
    }

    function formatCheckDetail(name, result) {
      if (!result.details) return escHtml(result.message || '');
      // V8 å †å†…å­˜ï¼šæ˜¾ç¤º heapUsed / heapMax
      if (name === 'memory' && result.details.heapUsedMB != null) {
        return result.details.heapUsedMB + ' MB / ' + result.details.heapMaxMB + ' MB';
      }
      // ç³»ç»Ÿ RAMï¼šæ˜¾ç¤ºå·²ç”¨ / æ€»é‡ Â· å‰©ä½™%
      if (name === 'system_memory' && result.details.totalMB != null) {
        const { usedMB, totalMB, freePct } = result.details;
        return 'å·²ç”¨ ' + usedMB + ' MB / ' + totalMB + ' MB Â· å‰©ä½™ ' + freePct + '%';
      }
      // å‘é‡è®°å¿†ï¼šæ˜¾ç¤ºæ¡æ•°
      if (name === 'vector_memory' && result.details.totalVectors != null) {
        return result.details.totalVectors + ' æ¡è®°å¿†';
      }
      // å…¶ä½™ï¼šæ˜¾ç¤º messageï¼ˆå·²æ˜¯ä¸­æ–‡ï¼‰
      if (result.message) return escHtml(result.message);
      return '';
    }

    // â”€â”€ Benchmark æ‘˜è¦æ¸²æŸ“ â”€â”€
    // 4ä¸ªç»´åº¦åŠä¸­æ–‡è¯´æ˜
    const BM_DIMS = [
      { key: 'correctness',   label: 'æ­£ç¡®æ€§',   hint: 'æ„å›¾ç†è§£ä¸è·¯ç”±å‡†ç¡®ç‡',   getValue: r => (r.metrics.correctness.overall * 100).toFixed(1) + '%',  grade: r => r.grade.correctness },
      { key: 'performance',   label: 'æ€§èƒ½',     hint: 'å¹³å‡å“åº”å»¶è¿Ÿ',          getValue: r => r.metrics.performance.latency.avg.toFixed(0) + 'ms',    grade: r => r.grade.performance },
      { key: 'generalization',label: 'æ³›åŒ–èƒ½åŠ›', hint: 'é›¶æ ·æœ¬ / è¯­ä¹‰å˜ä½“å¤„ç†', getValue: r => (r.generalization.overall * 100).toFixed(1) + '%',       grade: r => r.grade.generalization },
      { key: 'aiNative',      label: 'AI Native',hint: 'AI å†³ç­–å æ¯”ï¼ˆè¶Šé«˜è¶Šå¥½ï¼‰',getValue: r => (r.metrics.aiNative.aiDriven * 100).toFixed(1) + '%',   grade: r => r.grade.aiNative },
    ];

    function gradeClass(g) {
      return { A:'grade-A', B:'grade-B', C:'grade-C', D:'grade-D' }[g] || '';
    }

    function renderBenchmark(report) {
      // å±•ç¤ºæ€»è¯„å¾½ç«  + æ—¶é—´
      document.getElementById('bmMeta').style.display = 'flex';
      document.getElementById('bmGradeBadge').innerHTML = gradeBadgeHtml(report.grade.overall);
      document.getElementById('bmTimestamp').textContent =
        'æ›´æ–°äº ' + new Date(report.timestamp).toLocaleString('zh-CN', { month:'numeric', day:'numeric', hour:'2-digit', minute:'2-digit' });

      const cells = BM_DIMS.map(d => {
        const val   = d.getValue(report);
        const g     = d.grade(report);
        // ç™¾åˆ†æ¯”è¿›åº¦æ¡ï¼ˆms ç±»è·³è¿‡ï¼‰
        let bar = '';
        if (val.endsWith('%')) {
          const pct = parseFloat(val);
          bar = '<div class="mini-bar"><div class="mini-bar-fill" style="width:' + pct + '%"></div></div>';
        }
        return '<div class="bm-cell">' +
          '<div class="bm-label">' + d.label + '</div>' +
          '<div class="bm-value ' + gradeClass(g) + '">' + val + '</div>' +
          '<div class="bm-hint">' + d.hint + ' Â· ' + g + ' çº§</div>' +
          bar +
          '</div>';
      }).join('');

      document.getElementById('bmContent').innerHTML =
        '<div class="bm-grid">' + cells + '</div>';
    }

    function renderBenchmarkEmpty() {
      document.getElementById('bmContent').innerHTML =
        '<div class="placeholder">' +
        'æš‚æ—  Benchmark æŠ¥å‘Š&nbsp;&nbsp;' +
        '<a class="btn" href="/dashboard/benchmark">å‰å¾€è¿è¡Œ</a>' +
        '</div>';
    }

    async function loadBenchmark() {
      try {
        const resp = await fetch('/benchmark/report');
        if (!resp.ok) { renderBenchmarkEmpty(); return; }
        const report = await resp.json();
        renderBenchmark(report);
      } catch {
        renderBenchmarkEmpty();
      }
    }

    // â”€â”€ ä¸»çŠ¶æ€åŠ è½½ â”€â”€
    async function loadStatus() {
      try {
        const resp = await fetch('/api/status');
        if (!resp.ok) throw new Error('HTTP ' + resp.status);
        const data = await resp.json();

        document.getElementById('errorBar').style.display = 'none';
        renderHeader(data.health);
        renderMetrics(data.metrics);
        renderMemoryCard(data.health.checks);
        renderTasks(data.tasks);
        renderChecks(data.health.checks);
      } catch (err) {
        const bar = document.getElementById('errorBar');
        bar.style.display = 'block';
        bar.textContent = 'âš ï¸ æ— æ³•è·å–çŠ¶æ€æ•°æ®ï¼š' + err.message;
      }
    }

    // â”€â”€ å€’è®¡æ—¶ â”€â”€
    function startCountdown() {
      if (countdownTimer) clearInterval(countdownTimer);
      countdown = REFRESH_INTERVAL;
      updateCountdownUI();
      countdownTimer = setInterval(() => {
        countdown--;
        updateCountdownUI();
        if (countdown <= 0) refresh();
      }, 1000);
    }

    function updateCountdownUI() {
      document.getElementById('countdownText').textContent = countdown + 's ååˆ·æ–°';
      const pct = ((REFRESH_INTERVAL - countdown) / REFRESH_INTERVAL) * 100;
      document.getElementById('refreshBar').style.width = pct + '%';
    }

    // Benchmark ä¸éš 30s åˆ·æ–°ï¼ˆè¾ƒé‡ï¼‰ï¼Œä»…é¡µé¢åŠ è½½æ—¶æ‹‰ä¸€æ¬¡
    async function refresh() {
      await loadStatus();
      startCountdown();
    }

    // å¯åŠ¨
    refresh();
    loadBenchmark();
  </script>
</body>
</html>
