#!/usr/bin/env tsx
/**
 * Discord åä½œåŠŸèƒ½æµ‹è¯•è„šæœ¬
 *
 * ç”¨æ³•: tsx test-collaboration.ts "ä½ çš„æµ‹è¯•é—®é¢˜"
 *
 * æ¨¡æ‹ŸçœŸå®çš„ Discord åä½œåœºæ™¯ï¼š
 * - bot2 å’Œ bot3 æ”¶åˆ°å¸¦å®Œæ•´å¯¹è¯å†å²çš„æ¶ˆæ¯
 * - éªŒè¯å¯¹è¯å†å²æ ¼å¼åŒ–æ˜¯å¦æ­£ç¡®
 */

import { loadConfig } from "./src/js/shared/config.js";
import { PiEngine } from "./src/js/pi/engine.js";

/**
 * æ ¼å¼åŒ–å¯¹è¯å†å²ï¼ˆæ¨¡æ‹Ÿ fetchCollaborationHistory çš„è¾“å‡ºï¼‰
 */
function formatHistory(messages: Array<{ author: string; content: string; role?: string }>): string {
  return messages.map(msg => {
    const roleTag = msg.role ? ` [${msg.role}]` : "";
    return `ã€${msg.author}${roleTag}ã€‘ï¼š${msg.content}`;
  }).join("\n\n");
}

async function testCollaboration(userMessage: string) {
  console.log("=".repeat(80));
  console.log("ğŸ§ª Discord åä½œåŠŸèƒ½æµ‹è¯•ï¼ˆå¸¦å¯¹è¯å†å²ï¼‰");
  console.log("=".repeat(80));
  console.log();

  const config = loadConfig();

  // æ¨¡æ‹Ÿä¸‰ä¸ª bot çš„è§’è‰²
  const bots = [
    { agentId: "expert", username: "JPClaw", displayName: "æ­£é¢ä¸“å®¶" },
    { agentId: "critic", username: "JPClaw2", displayName: "åé¢è´¨ç–‘è€…" },
    { agentId: "thinker", username: "JPClaw3", displayName: "æ·±åº¦æ€è€ƒè€…" }
  ];

  // ä¿å­˜å¯¹è¯å†å²
  const conversationHistory: Array<{ author: string; content: string; role?: string }> = [];

  // ç”¨æˆ·åŸå§‹é—®é¢˜
  conversationHistory.push({
    author: "jiangpingt_04698_20949",
    content: userMessage
  });

  console.log(`ğŸ“ ç”¨æˆ·é—®é¢˜: ${userMessage}`);
  console.log();

  for (let i = 0; i < bots.length; i++) {
    const bot = bots[i];
    console.log("â”€".repeat(80));
    console.log(`ğŸ¤– ${bot.displayName} (${bot.agentId}) å¼€å§‹å›å¤...`);
    console.log();

    const startTime = Date.now();

    try {
      // åˆ›å»ºå¼•æ“å®ä¾‹
      const engine = new PiEngine(config, bot.agentId);

      // å‡†å¤‡è¾“å…¥ï¼ˆæ¨¡æ‹Ÿ Discord åä½œè§¦å‘æ¶ˆæ¯ï¼‰
      let input: string;

      if (i === 0) {
        // Bot1 (expert): ç›´æ¥å›ç­”ç”¨æˆ·é—®é¢˜
        input = userMessage;
        console.log("ğŸ’¬ æ”¶åˆ°çš„æ¶ˆæ¯:");
        console.log(`  "${input}"`);
        console.log();
      } else {
        // Bot2/Bot3: æ”¶åˆ°å¸¦å¯¹è¯å†å²çš„è§¦å‘æ¶ˆæ¯
        const history = formatHistory(conversationHistory);
        const triggerMsg = `<@${bot.username}> æ¥è‡ª<@jiangpingt_04698_20949>çš„é—®é¢˜ ğŸ‘† è¯·ä»ã€${bot.displayName}ã€‘è§’åº¦åˆ†æä¸Šè¿°å†…å®¹`;

        input = `${history}\n\n---\n\n${triggerMsg}`;

        console.log("ğŸ’¬ æ”¶åˆ°çš„æ¶ˆæ¯ï¼ˆåŒ…å«å¯¹è¯å†å²ï¼‰:");
        console.log("â”Œâ”€ å¯¹è¯å†å² â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€");
        console.log(history);
        console.log("â”œâ”€ è§¦å‘æ¶ˆæ¯ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€");
        console.log(triggerMsg);
        console.log("â”œâ”€ å®Œæ•´è¾“å…¥ï¼ˆAI å®é™…æ”¶åˆ°çš„å†…å®¹ï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€");
        console.log(input);
        console.log("â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€");
        console.log();
        console.log(`ğŸ“Š ç»Ÿè®¡: å†å²é•¿åº¦ ${history.length} å­—ç¬¦, å®Œæ•´æ¶ˆæ¯ ${input.length} å­—ç¬¦`);
        console.log();
      }

      // è°ƒç”¨ AI
      const response = await engine.reply(input, {
        userId: "test_user",
        userName: "æµ‹è¯•ç”¨æˆ·",
        channelId: "test_channel",
        agentId: bot.agentId
      });

      const duration = ((Date.now() - startTime) / 1000).toFixed(2);

      console.log(`âœ… å›å¤å®Œæˆ (ç”¨æ—¶ ${duration}s)`);
      console.log();
      console.log("å›å¤å†…å®¹:");
      console.log("â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€");
      console.log(response);
      console.log("â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€");
      console.log();

      // ä¿å­˜åˆ°å¯¹è¯å†å²
      conversationHistory.push({
        author: bot.username,
        content: response,
        role: bot.agentId
      });

    } catch (error) {
      console.error(`âŒ ${bot.displayName} å›å¤å¤±è´¥:`, error);
      console.error(error);
      break;
    }
  }

  console.log("=".repeat(80));
  console.log("âœ… åä½œæµ‹è¯•å®Œæˆ");
  console.log("=".repeat(80));
  console.log();
  console.log("ğŸ“‹ å®Œæ•´å¯¹è¯å†å²:");
  console.log(formatHistory(conversationHistory));
}

// è·å–å‘½ä»¤è¡Œå‚æ•°
const userMessage = process.argv[2] || "æˆ‘çˆ±åƒå¤©æ´¥çš„ç…é¥¼æœå­ï¼Œä½ çˆ±åƒå—ï¼Œä¸ºä»€ä¹ˆ";

testCollaboration(userMessage)
  .then(() => process.exit(0))
  .catch((error) => {
    console.error("æµ‹è¯•å¤±è´¥:", error);
    process.exit(1);
  });
