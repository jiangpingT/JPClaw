# AGENTS

## 用户偏好与项目规范（长期约束）

### 用户偏好
- 用户称呼：姜哥
- 我的昵称：阿策（用户这样称呼我）

### 核心操作规范
- 重启服务的唯一正确方式：必须使用 `npm run restart`
- 禁止方式：手动 `node dist/...`、`pkill` 后手动启动、直接操作进程
- 原因：项目使用 launchd 管理服务，手动操作会导致端口冲突和服务状态不一致
- 适用场景：任何代码修改后需要重新加载时

### 常用命令
- 查看服务状态：`npm run status`
- 查看日志：`npm run logs`
- 停止服务：`npm run stop`

### 工程原则（核心）
- 永远不要硬编码
- 默认必须泛化实现：优先考虑通用、可扩展的架构
- 硬编码是最后手段：只有在实在没办法且姜哥明确确认后才可以硬编码
- 泛化是第一优先级：任何实现都要考虑可扩展性和复用性

检查清单：
1. 这个逻辑能否通过配置/描述实现？
2. 这个逻辑能否让 AI 智能判断？
3. 这个逻辑能否设计成通用机制？
4. 如果必须硬编码，是否已经跟姜哥确认？

### 核心思维方式（从多智能体实现中总结）
三大原则：
1. 泛化优先：设计通用机制而不是特定实现
2. AI 驱动：让 AI 理解和决策，而不是硬编码规则
3. 从根本解决问题：找到本质原因，不治标不治本

实践指南：
- 泛化优先：从配置系统/通用机制切入，避免针对具体场景优化
- AI 驱动：给 AI 足够上下文，让它做正确决策
- 从根本解决问题：治本优先，避免绕过问题

经典案例（保留做法，不硬编码）：
- 问题：Bot2 看不到 Bot1 回复
- 治标：增加延迟
- 治本：AI 判断前刷新历史（方案C）

### API 和服务约束
外部 API（没有配额）：
- OpenAI API：无额度（ChatGPT Pro 订阅不等于 API 权限）
- Gemini API：无免费配额
- 禁止直连这些外部 API

可用的 API 和工具：
- JPClaw Gateway（本地服务）
  - 端口：18790（固定端口，禁止使用其他端口）
  - 主机：127.0.0.1
  - 配置文件：`sessions/config.json`
- 公司多模态网关（图像生成/转录/TTS/LLM）
  - Base URL：`https://llm-guard.mininglamp.com`
  - API Key：使用环境变量（不要写入仓库文件）
  - 支持模型：`gemini-3-pro-image`、`gpt-4o`、`whisper-1`、`tts-1-hd` 等
- Anthropic API：已配置（vibe.deepminer.ai 代理）
- 本地工具：优先使用本地命令行工具（ffmpeg、ImageMagick 等）
- 本地 Whisper：已安装，用于语音转录

### 项目语言规范
原则：
- 描述性文本默认使用中文
- 保持整个项目语言一致性
- LLM 中英文理解能力相同，无需为了“精确性”使用英文

必须使用中文：
1. Tool descriptions
2. Skill descriptions（SKILL.md frontmatter description）
3. System prompts
4. 用户可见文本（错误消息/提示信息/返回内容）
5. 日志输出（中文为主，可混用英文术语）

可以使用英文：
- 代码标识符（变量名/函数名/类名）
- 技术术语（API/SDK/HTTP/JSON/LLM 等）
- 第三方库接口
- Git commit messages（可选）
- 代码注释（中文优先，英文可接受）

### 文档更新工作流
- 主动检测：每次对话结束前检查是否需要更新文档
- 主动提醒：检测到重要变更时询问是否需要记录
- 快速执行：确认后立即更新

三层策略：
1. `CHANGELOG.md`：功能完成后检查
2. ADR：架构决策时提醒起草
3. `ARCHITECTURE.md`：重大变更或每月一次

触发关键词：
- “完成了/搞定了/好了” → CHANGELOG 检查
- “我们决定/选择方案X/采用XX” → ADR 检查
- “新增XX渠道/新模块” → ARCHITECTURE 检查

### 变更展示规范
- 每次完成修改后，必须给出改动总结（改了什么/为什么改/行为变化/风险点）。
- 回复中需自动展开关键 diff 摘要，便于直接在 UI 里看到核心改动。
- 精简规则：先给 3 行短总结（改了什么/为什么/风险），再给 `关键 diff 摘要`，摘要不超过 10 行；超出只保留关键片段。

### 完美实现参考
- 多智能体协作系统（Discord Bot1/Bot2/Bot3）
  - 特点：AI 驱动、无状态观察者、方案C双重刷新、泛化配置
  - 参考文档：`/Users/mlamp/Workspace/JPClaw/docs/adr/001-multi-agent-collaboration.md`

## 工作流

1. 先定位：明确用户目标、约束、输入输出与验收标准。
2. 先最小闭环：让功能跑通并可验证（health/check/test）。
3. 再增强：性能、稳定性、安全、可观测性、易用性。
4. 再沉淀：把复用性强的流程写成 Skill/脚本/文档。

## 记忆与文件优先

- 记忆以落盘为准：JSON + daily + MEMORY.md。
- 当用户要求“记住/长期记住”，必须落盘并能在后续提问中稳定引用。
- 读写一致：同一套 writer 与检索逻辑，避免双源漂移。
